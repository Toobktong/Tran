<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î Lat Long ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô</title>
    <style>
        @font-face {
            font-family: 'TH Sarabun';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-06@1.0/TH Sarabun.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'TH Sarabun', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            color: white;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #e1e8ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #555;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .sample-data {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .sample-data h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .sample-data pre {
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 1.1rem;
        }
        
        .settings-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            flex: 1;
            min-width: 250px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.2rem;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
        }
        
        .results-section {
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-header h2 {
            font-size: 1.8rem;
        }
        
        .clusters-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .cluster-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cluster-title {
            font-weight: 600;
            color: #333;
            font-size: 1.3rem;
        }
        
        .cluster-count {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 1.1rem;
        }
        
        .cluster-items {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .cluster-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cluster-item:last-child {
            border-bottom: none;
        }
        
        .item-name {
            font-weight: 500;
            color: #444;
            font-size: 1.2rem;
        }
        
        .item-coords {
            font-size: 1.1rem;
            color: #666;
            margin-top: 3px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
        }
        
        .summary-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            background: #ffeaea;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            font-size: 1.2rem;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .settings-section {
                flex-direction: column;
            }
            
            .clusters-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î Lat Long ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô</h1>
            <p class="subtitle">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô</p>
        </header>
        
        <main>
            <div class="card upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p class="upload-text">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    <p class="upload-text" style="font-size: 1.1rem; opacity: 0.7;">(‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "A ‡∏ä‡∏∑‡πà‡∏≠" ‡πÅ‡∏•‡∏∞ "B ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î")</p>
                    <button class="btn" id="browseBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                </div>
                
                <div class="sample-data">
                    <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV:</h3>
                    <pre>"A ‡∏ä‡∏∑‡πà‡∏≠","B ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î"
"‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥","13.7563,100.5018"
"‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå","13.7592,100.4998"
"‡∏™‡∏¢‡∏≤‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏Å‡∏≠‡∏ô","13.7466,100.5346"
"‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥","13.6899,100.7501"
"‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•‡πÄ‡∏ß‡∏¥‡∏•‡∏î‡πå","13.7470,100.5360"</pre>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
            </div>
            
            <div class="card settings-section">
                <div class="setting-group">
                    <label for="distanceThreshold">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£):</label>
                    <input type="number" id="distanceThreshold" value="5" min="0.1" step="0.1">
                </div>
                <div class="setting-group">
                    <label for="algorithm">‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ò‡∏∂‡∏°:</label>
                    <select id="algorithm">
                        <option value="simple">Simple Clustering</option>
                        <option value="dbscan">DBSCAN (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>&nbsp;</label>
                    <button class="btn" id="processBtn" disabled>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
                    <button class="btn" id="downloadBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
                </div>
                
                <div class="clusters-container" id="clustersContainer"></div>
                
                <div class="summary-card">
                    <div class="summary-title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalPoints">0</div>
                            <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="clusterCount">0</div>
                            <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgDistance">0</div>
                            <div class="stat-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏Å‡∏°.)</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô <script> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- ...existing code... -->

<script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let pointsData = [];
        let clusteredData = [];
        
        // ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const processBtn = document.getElementById('processBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const clustersContainer = document.getElementById('clustersContainer');
        const distanceThreshold = document.getElementById('distanceThreshold');
        
        // Event Listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processClustering);
        
        // Drag and drop events
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    processBtn.disabled = false;
                    showError('');
                } catch (error) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á CSV ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
            }
            
            pointsData = [];
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö header row
            const headerLine = lines[0];
            const headers = parseCSVRow(headerLine);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const nameColumnIndex = headers.findIndex(h => h.trim() === 'A ‡∏ä‡∏∑‡πà‡∏≠');
            const coordsColumnIndex = headers.findIndex(h => h.trim() === 'B ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î');
            
            if (nameColumnIndex === -1 || coordsColumnIndex === -1) {
                throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "A ‡∏ä‡∏∑‡πà‡∏≠" ‡πÅ‡∏•‡∏∞ "B ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î"');
            }
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                const values = parseCSVRow(line);
                if (values.length > Math.max(nameColumnIndex, coordsColumnIndex)) {
                    const name = values[nameColumnIndex];
                    const coords = values[coordsColumnIndex];
                    
                    if (coords) {
                        const coordParts = coords.split(',');
                        if (coordParts.length >= 2) {
                            const lat = parseFloat(coordParts[0]);
                            const lng = parseFloat(coordParts[1]);
                            
                            if (!isNaN(lat) && !isNaN(lng)) {
                                pointsData.push({
                                    name: name,
                                    lat: lat,
                                    lng: lng
                                });
                            }
                        }
                    }
                }
            }
            
            if (pointsData.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å CSV row ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö quoted values
        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < row.length && row[i + 1] === '"') {
                        // Double quotes inside quoted field
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quotes
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last field
            result.push(current.trim());
            return result;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å‡πÉ‡∏ô‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
        function simpleClustering(points, threshold) {
            const clusters = [];
            const visited = new Array(points.length).fill(false);
            
            for (let i = 0; i < points.length; i++) {
                if (visited[i]) continue;
                
                const cluster = [points[i]];
                visited[i] = true;
                
                for (let j = i + 1; j < points.length; j++) {
                    if (visited[j]) continue;
                    
                    const distance = calculateDistance(
                        points[i].lat, points[i].lng,
                        points[j].lat, points[j].lng
                    );
                    
                    if (distance <= threshold) {
                        cluster.push(points[j]);
                        visited[j] = true;
                    }
                }
                
                clusters.push(cluster);
            }
            
            return clusters;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô DBSCAN
        function dbscanClustering(points, eps, minPts) {
            const clusters = [];
            const visited = new Array(points.length).fill(false);
            const clusterLabels = new Array(points.length).fill(-1);
            let clusterId = 0;
            
            for (let i = 0; i < points.length; i++) {
                if (visited[i]) continue;
                
                visited[i] = true;
                const neighbors = getNeighbors(points, i, eps);
                
                if (neighbors.length < minPts) {
                    // Noise point
                    clusterLabels[i] = -1;
                } else {
                    // Core point
                    clusterLabels[i] = clusterId;
                    expandCluster(points, i, neighbors, clusterLabels, visited, clusterId, eps, minPts);
                    clusterId++;
                }
            }
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° clusterLabels
            for (let i = 0; i < clusterId; i++) {
                const cluster = [];
                for (let j = 0; j < points.length; j++) {
                    if (clusterLabels[j] === i) {
                        cluster.push(points[j]);
                    }
                }
                if (cluster.length > 0) {
                    clusters.push(cluster);
                }
            }
            
            // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î
            const noisePoints = [];
            for (let i = 0; i < points.length; i++) {
                if (clusterLabels[i] === -1) {
                    noisePoints.push([points[i]]);
                }
            }
            
            return clusters.concat(noisePoints);
        }
        
        function getNeighbors(points, pointIdx, eps) {
            const neighbors = [];
            for (let i = 0; i < points.length; i++) {
                if (i === pointIdx) continue;
                const distance = calculateDistance(
                    points[pointIdx].lat, points[pointIdx].lng,
                    points[i].lat, points[i].lng
                );
                if (distance <= eps) {
                    neighbors.push(i);
                }
            }
            return neighbors;
        }
        
        function expandCluster(points, pointIdx, neighbors, clusterLabels, visited, clusterId, eps, minPts) {
            let i = 0;
            while (i < neighbors.length) {
                const neighborIdx = neighbors[i];
                if (!visited[neighborIdx]) {
                    visited[neighborIdx] = true;
                    const neighborNeighbors = getNeighbors(points, neighborIdx, eps);
                    if (neighborNeighbors.length >= minPts) {
                        neighbors = neighbors.concat(neighborNeighbors.filter(idx => !neighbors.includes(idx)));
                    }
                }
                if (clusterLabels[neighborIdx] === -1) {
                    clusterLabels[neighborIdx] = clusterId;
                }
                i++;
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
        function processClustering() {
            if (pointsData.length === 0) {
                showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•');
                return;
            }
            
            showLoading(true);
            
            // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á loading
            setTimeout(() => {
                try {
                    const threshold = parseFloat(distanceThreshold.value) || 5;
                    const algorithm = document.getElementById('algorithm').value;
                    
                    let clusters;
                    if (algorithm === 'dbscan') {
                        clusters = dbscanClustering(pointsData, threshold, 2);
                    } else {
                        clusters = simpleClustering(pointsData, threshold);
                    }
                    
                    clusteredData = clusters;
                    displayResults(clusters);
                    showLoading(false);
                    resultsSection.style.display = 'block';
                } catch (error) {
                    showLoading(false);
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ' + error.message);
                }
            }, 100);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function displayResults(clusters) {
            clustersContainer.innerHTML = '';
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            let totalPoints = 0;
            let totalDistance = 0;
            let distanceCount = 0;
            
            clusters.forEach((cluster, index) => {
                totalPoints += cluster.length;
                
                const clusterCard = document.createElement('div');
                clusterCard.className = 'cluster-card';
                
                const clusterHeader = document.createElement('div');
                clusterHeader.className = 'cluster-header';
                
                const clusterTitle = document.createElement('div');
                clusterTitle.className = 'cluster-title';
                clusterTitle.textContent = `‡∏Å‡∏•‡∏∏‡πà‡∏° ${index + 1}`;
                
                const clusterCount = document.createElement('div');
                clusterCount.className = 'cluster-count';
                clusterCount.textContent = cluster.length;
                
                clusterHeader.appendChild(clusterTitle);
                clusterHeader.appendChild(clusterCount);
                
                const clusterItems = document.createElement('div');
                clusterItems.className = 'cluster-items';
                
                cluster.forEach(point => {
                    const item = document.createElement('div');
                    item.className = 'cluster-item';
                    
                    const itemName = document.createElement('div');
                    itemName.className = 'item-name';
                    itemName.textContent = point.name;
                    
                    const itemCoords = document.createElement('div');
                    itemCoords.className = 'item-coords';
                    itemCoords.textContent = `${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}`;
                    
                    item.appendChild(itemName);
                    item.appendChild(itemCoords);
                    clusterItems.appendChild(item);
                });
                
                clusterCard.appendChild(clusterHeader);
                clusterCard.appendChild(clusterItems);
                clustersContainer.appendChild(clusterCard);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                if (cluster.length > 1) {
                    for (let i = 0; i < cluster.length; i++) {
                        for (let j = i + 1; j < cluster.length; j++) {
                            const distance = calculateDistance(
                                cluster[i].lat, cluster[i].lng,
                                cluster[j].lat, cluster[j].lng
                            );
                            totalDistance += distance;
                            distanceCount++;
                        }
                    }
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('clusterCount').textContent = clusters.length;
            const avgDistance = distanceCount > 0 ? (totalDistance / distanceCount) : 0;
            document.getElementById('avgDistance').textContent = avgDistance.toFixed(2);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô loading
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = message ? 'block' : 'none';
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô Excel
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (clusteredData.length === 0) return;

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const ws_data = [
                ["‡∏Å‡∏•‡∏∏‡πà‡∏°", "‡∏ä‡∏∑‡πà‡∏≠", "‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î", "‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î", "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏Å‡∏°.)"]
            ];
            clusteredData.forEach((cluster, clusterIndex) => {
                const refPoint = cluster[0]; // ‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
                cluster.forEach((point, idx) => {
                    let distance = 0;
                    if (idx > 0) {
                        distance = calculateDistance(
                            refPoint.lat, refPoint.lng,
                            point.lat, point.lng
                        );
                    }
                    ws_data.push([
                        clusterIndex + 1,
                        point.name,
                        point.lat,
                        point.lng,
                        idx === 0 ? "0" : distance.toFixed(3)
                    ]);
                });
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á worksheet ‡πÅ‡∏•‡∏∞ workbook
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î style ‡∏ü‡∏≠‡∏ô‡∏ï‡πå TH Sarabun PSK
            const sarabunFont = { name: "TH Sarabun PSK", sz: 16 };
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell_address]) continue;
                    if (!ws[cell_address].s) ws[cell_address].s = {};
                    ws[cell_address].s.font = sarabunFont;
                }
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°");

            XLSX.writeFile(wb, "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î.xlsx");
        });
    </script>
</body>
</html>